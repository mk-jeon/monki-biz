<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담현황 - MONKi Biz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 칸반보드 스타일 */
        .kanban-column {
            min-width: 300px;
            max-width: 350px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }
        
        .kanban-column:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .kanban-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: grab;
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .kanban-card:active {
            cursor: grabbing;
        }
        
        .kanban-card.dragging {
            opacity: 0.5;
        }
        
        .kanban-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 20px;
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* 스크롤바 스타일 */
        .kanban-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .kanban-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .kanban-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .kanban-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 로딩 스피너 */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 헤더 -->
    <div class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="max-w-full mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-comments mr-2 text-blue-500"></i>
                        상담현황
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">고객 상담 및 진행 상황 관리</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openNewConsultationModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        신규 상담 등록
                    </button>
                    <button onclick="refreshData()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button onclick="window.location.href='/'" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 칸반보드 컨테이너 -->
    <div id="kanbanContainer" class="kanban-container">
        <!-- 동적으로 생성 -->
    </div>

    <!-- 로딩 스피너 -->
    <div id="loadingSpinner" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden">
        <div class="spinner"></div>
    </div>

    <!-- 신규 상담 등록 모달 -->
    <div id="newConsultationModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-plus-circle mr-2 text-blue-500"></i>
                    신규 상담 등록
                </h2>
                <button onclick="closeNewConsultationModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="newConsultationForm" onsubmit="handleNewConsultation(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">고객명 *</label>
                        <input type="text" name="customer_name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">전화번호 *</label>
                        <input type="tel" name="phone" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="010-1234-5678">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">지역</label>
                        <input type="text" name="region" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">인입 채널 *</label>
                        <select name="channel" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">선택하세요</option>
                            <option value="전화">전화</option>
                            <option value="이메일">이메일</option>
                            <option value="방문">방문</option>
                            <option value="웹사이트">웹사이트</option>
                            <option value="소개">소개</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상담 주체</label>
                        <input type="text" name="consultant_name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">업종</label>
                        <input type="text" name="business_type" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상호명</label>
                        <input type="text" name="business_name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">문의 내용</label>
                        <textarea name="inquiry_content" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeNewConsultationModal()" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                        취소
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition">
                        <i class="fas fa-save mr-2"></i>
                        등록
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 상세보기/수정 모달 -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                    상담 상세 정보
                </h2>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="detailForm" onsubmit="handleUpdateConsultation(event)">
                <input type="hidden" name="id" id="detail_id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 bg-blue-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">상담 상태</p>
                                <p class="text-lg font-bold text-blue-600" id="detail_status_display"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">등록일</p>
                                <p class="text-lg font-bold text-gray-800" id="detail_created_at"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">고객명 *</label>
                        <input type="text" name="customer_name" id="detail_customer_name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">전화번호 *</label>
                        <input type="tel" name="phone" id="detail_phone" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">지역</label>
                        <input type="text" name="region" id="detail_region" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">인입 채널</label>
                        <select name="channel" id="detail_channel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="전화">전화</option>
                            <option value="이메일">이메일</option>
                            <option value="방문">방문</option>
                            <option value="웹사이트">웹사이트</option>
                            <option value="소개">소개</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상담 주체</label>
                        <input type="text" name="consultant_name" id="detail_consultant_name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">업종</label>
                        <input type="text" name="business_type" id="detail_business_type" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상호명</label>
                        <input type="text" name="business_name" id="detail_business_name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상담 결과</label>
                        <select name="consultation_result" id="detail_consultation_result" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">선택하세요</option>
                            <option value="진행중">진행중</option>
                            <option value="성공">성공</option>
                            <option value="보류">보류</option>
                            <option value="실패">실패</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">실패 사유</label>
                        <input type="text" name="failure_reason" id="detail_failure_reason" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">문의 내용</label>
                        <textarea name="inquiry_content" id="detail_inquiry_content" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">상담 내용</label>
                        <textarea name="consultation_content" id="detail_consultation_content" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button type="button" onclick="handleDeleteConsultation()" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                        <i class="fas fa-trash mr-2"></i>
                        삭제
                    </button>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeDetailModal()" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                            취소
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition">
                            <i class="fas fa-save mr-2"></i>
                            저장
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // 전역 변수
        let consultations = [];
        let currentUser = null;

        // 칸반 보드 상태 정의
        const KANBAN_STATUSES = [
            { id: 'new', name: '신규 인입', color: 'blue', icon: 'fa-bell' },
            { id: 'in_progress', name: '상담 진행중', color: 'yellow', icon: 'fa-comments' },
            { id: 'visit_scheduled', name: '방문 예약', color: 'purple', icon: 'fa-calendar-check' },
            { id: 'completed', name: '상담 완료', color: 'green', icon: 'fa-check-circle' },
            { id: 'failed', name: '상담 실패', color: 'red', icon: 'fa-times-circle' }
        ];

        // 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSession();
            await loadConsultations();
            renderKanban();
        });

        // 세션 체크
        async function checkSession() {
            try {
                const response = await axios.get('/api/auth/session');
                currentUser = response.data.user;
            } catch (error) {
                console.error('세션 체크 실패:', error);
                alert('로그인이 필요합니다.');
                window.location.href = '/';
            }
        }

        // 데이터 로드
        async function loadConsultations() {
            showLoading();
            try {
                const response = await axios.get('/api/consultations');
                consultations = response.data;
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                alert('데이터를 불러오는데 실패했습니다.');
            } finally {
                hideLoading();
            }
        }

        // 칸반보드 렌더링
        function renderKanban() {
            const container = document.getElementById('kanbanContainer');
            container.innerHTML = '';

            KANBAN_STATUSES.forEach(status => {
                const column = createKanbanColumn(status);
                container.appendChild(column);
            });
        }

        // 칸반 컬럼 생성
        function createKanbanColumn(status) {
            const column = document.createElement('div');
            column.className = 'kanban-column';
            column.dataset.status = status.id;

            const items = consultations.filter(c => c.status === status.id);
            
            column.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <i class="fas ${status.icon} text-${status.color}-500"></i>
                        <h3 class="font-bold text-gray-800">${status.name}</h3>
                    </div>
                    <span class="bg-${status.color}-100 text-${status.color}-700 px-3 py-1 rounded-full text-sm font-bold">
                        ${items.length}
                    </span>
                </div>
                <div class="kanban-cards" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    ${items.map(item => createKanbanCard(item)).join('')}
                </div>
            `;

            return column;
        }

        // 칸반 카드 생성
        function createKanbanCard(item) {
            return `
                <div class="kanban-card" 
                     draggable="true" 
                     data-id="${item.id}"
                     ondragstart="handleDragStart(event)"
                     ondragend="handleDragEnd(event)"
                     onclick="openDetailModal(${item.id})">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-bold text-gray-800">${item.customer_name || '고객명 없음'}</h4>
                        <span class="text-xs text-gray-500">${formatDate(item.created_at)}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">
                        <i class="fas fa-phone mr-1"></i>
                        ${item.phone || '-'}
                    </p>
                    <p class="text-sm text-gray-600 mb-2">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        ${item.region || '-'}
                    </p>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t">
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                            ${item.channel || '채널 미지정'}
                        </span>
                        <span class="text-xs text-gray-500">
                            ${item.consultant_name || '-'}
                        </span>
                    </div>
                </div>
            `;
        }

        // 드래그 앤 드롭 핸들러
        let draggedElement = null;

        function handleDragStart(event) {
            draggedElement = event.target;
            event.target.classList.add('dragging');
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
        }

        function handleDragOver(event) {
            event.preventDefault();
        }

        async function handleDrop(event) {
            event.preventDefault();
            
            if (!draggedElement) return;

            const targetColumn = event.target.closest('.kanban-column');
            if (!targetColumn) return;

            const newStatus = targetColumn.dataset.status;
            const itemId = draggedElement.dataset.id;

            try {
                await axios.put(`/api/consultations/${itemId}`, { status: newStatus });
                await loadConsultations();
                renderKanban();
            } catch (error) {
                console.error('상태 변경 실패:', error);
                alert('상태 변경에 실패했습니다.');
            }

            draggedElement = null;
        }

        // 신규 상담 등록 모달
        function openNewConsultationModal() {
            document.getElementById('newConsultationModal').classList.add('active');
        }

        function closeNewConsultationModal() {
            document.getElementById('newConsultationModal').classList.remove('active');
            document.getElementById('newConsultationForm').reset();
        }

        async function handleNewConsultation(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            data.status = 'new';

            showLoading();
            try {
                await axios.post('/api/consultations', data);
                closeNewConsultationModal();
                await loadConsultations();
                renderKanban();
                alert('상담이 등록되었습니다.');
            } catch (error) {
                console.error('등록 실패:', error);
                alert('등록에 실패했습니다.');
            } finally {
                hideLoading();
            }
        }

        // 상세보기 모달
        function openDetailModal(id) {
            const item = consultations.find(c => c.id === id);
            if (!item) return;

            document.getElementById('detail_id').value = item.id;
            document.getElementById('detail_customer_name').value = item.customer_name || '';
            document.getElementById('detail_phone').value = item.phone || '';
            document.getElementById('detail_region').value = item.region || '';
            document.getElementById('detail_channel').value = item.channel || '';
            document.getElementById('detail_consultant_name').value = item.consultant_name || '';
            document.getElementById('detail_business_type').value = item.business_type || '';
            document.getElementById('detail_business_name').value = item.business_name || '';
            document.getElementById('detail_consultation_result').value = item.consultation_result || '';
            document.getElementById('detail_failure_reason').value = item.failure_reason || '';
            document.getElementById('detail_inquiry_content').value = item.inquiry_content || '';
            document.getElementById('detail_consultation_content').value = item.consultation_content || '';
            document.getElementById('detail_status_display').textContent = getStatusName(item.status);
            document.getElementById('detail_created_at').textContent = formatDate(item.created_at);

            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        async function handleUpdateConsultation(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            const id = data.id;
            delete data.id;

            showLoading();
            try {
                await axios.put(`/api/consultations/${id}`, data);
                closeDetailModal();
                await loadConsultations();
                renderKanban();
                alert('수정되었습니다.');
            } catch (error) {
                console.error('수정 실패:', error);
                alert('수정에 실패했습니다.');
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteConsultation() {
            if (!confirm('정말 삭제하시겠습니까?')) return;

            const id = document.getElementById('detail_id').value;

            showLoading();
            try {
                await axios.delete(`/api/consultations/${id}`);
                closeDetailModal();
                await loadConsultations();
                renderKanban();
                alert('삭제되었습니다.');
            } catch (error) {
                console.error('삭제 실패:', error);
                alert('삭제에 실패했습니다.');
            } finally {
                hideLoading();
            }
        }

        // 유틸리티 함수
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        function getStatusName(statusId) {
            const status = KANBAN_STATUSES.find(s => s.id === statusId);
            return status ? status.name : statusId;
        }

        async function refreshData() {
            await loadConsultations();
            renderKanban();
        }

        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }
    </script>
</body>
</html>
